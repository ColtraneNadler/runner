const sceneTitle=document.getElementById("sceneTitle"),scoreWrapElement=document.getElementById("score-wrap"),scoreElement=document.getElementById("score"),prevOutfitBtn=document.getElementById("outfit-prev"),nextOutfitBtn=document.getElementById("outfit-next"),prevEnvBtn=document.getElementById("level-prev"),nextEnvBtn=document.getElementById("level-next");let paused=!1,leaderboardElement=document.getElementById("popup-wrapper"),leaderboardScoreElement=document.getElementById("leaderboard-score"),leaderboardScoresElement=document.getElementById("leaderboard-scores"),levelImageElement=document.getElementById("level-image"),levelNameElement=document.getElementById("level-name"),characterNameElement=document.getElementById("character-name"),levelNames=["HOLY","LONELY","MONSTER"],scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),renderer.physicallyCorrectLights=!0,renderer.gammaFactor=2.2,renderer.outputEncoding=THREE.sRGBEncoding,renderer.setSize(window.innerWidth,window.innerHeight);let pmremGenerator=new THREE.PMREMGenerator(renderer);pmremGenerator.compileEquirectangularShader(),document.body.appendChild(renderer.domElement),camera.rotation.x=-.14,camera.position.y=1.4,camera.position.x=0,camera.position.z=4.6;let hemiLight=new THREE.HemisphereLight(16777215,4473924,2);hemiLight.position.set(0,50,-100),scene.add(hemiLight);let dirLight=new THREE.DirectionalLight(16777215,.05);dirLight.position.set(15,30,-100),scene.add(dirLight);let loader=new THREE.GLTFLoader,jumping=!1,jump_time=0,envs=[["/assets/Env1Packaged/Enviroment1Packaged.gltf",InitConstructionEnv,SetUpStaticConstructionEnv,ConstructionSpawnTypes,SetUpConstructionEnvProps],["/assets/Env2Packaged/Enviroment2Packaged.gltf",InitCityEnv,SetUpStaticCityEnv,CitySpawnTypes,SetUpCityEnvProps],["/assets/Env3Packaged/Enviroment3Packaged.gltf",InitForestEnv,SetUpStaticForestEnv,ForestSpawnTypes,SetUpForestEnvProps]],initialized=[];function createPathStrings(e){const n="/assets/cSkybox_small/"+e;return["ft","bk","up","dn","lf","rt"].map(e=>n+"_"+e+".jpg")}function createMaterialArray(e,n){return createPathStrings(e).map(e=>{let t=(new THREE.TextureLoader).load(e);return new THREE.MeshBasicMaterial({color:n,map:t,side:THREE.BackSide,fog:!1})})}envs.forEach(e=>{let n=new EnvController(e[1],e[2],e[3],e[4],13.2466,10);loader.load(e[0],function(t){n.Init(t),e.push(n),initialized.push(1)},null,console.log)});let skybox,materialArray=[];function initSkybox(e){materialArray=createMaterialArray("cartoon",e);let n=new THREE.BoxGeometry(1e3,1e3,1e3);(skybox=new THREE.Mesh(n,materialArray)).position.set(200,0,0),scene.add(skybox),skybox.visible=!1}initSkybox(new THREE.Color("#dfa6fb"));const outfits=[[],[],[]];let avatar,boy_clips,boy_mixer,currentOutfit=0;function setUpForCurrentOutfit(){let e=avatar.getObjectByName("geo");for(let n=0;n<outfits.length;n++)outfits[n].forEach(t=>{e.children[t].visible=n==currentOutfit})}let boy_actions=[];const animations={NONE:-1,OLLIE:0,JUMP:1,PUSH:2,TURN_LEFT:3,TURN_RIGHT:4,FALL:5,IDLE:6};let envController,current_animation=animations.Push,timeout=e=>new Promise((n,t)=>setTimeout(n,e));loader.load("/assets/bieberRC16/bSkaterRC16.glb",async function(e){let n=e.scene;console.log("gl.biRC13.lod"+Math.random().toString().substring(0,5)),window.avatar_loaded=!0,n.traverse(e=>{e instanceof THREE.Mesh&&(e.material.encoding=THREE.sRGBEncoding,e.material.roughness=.9,e.material.metalness=0,e.material.side=THREE.DoubleSide)}),scene.add(e.scene),(avatar=e.scene).getObjectByName("geo").children.forEach((e,n)=>{e.name.startsWith("o1")?outfits[2].push(n):e.name.startsWith("o4")?outfits[1].push(n):e.name.startsWith("o2")?outfits[0].push(n):e.name.startsWith("o3")&&(e.visible=!1)}),setUpForCurrentOutfit(),boy_clips=e.animations,boy_mixer=new THREE.AnimationMixer(e.scene),boy_clips.forEach(e=>{let n=boy_mixer.clipAction(e);n.play(),boy_actions.push(n),n.setEffectiveWeight(0),n.setLoop(THREE.LoopOnce),n.clampWhenFinished=!0}),boy_actions[animations.PUSH].setLoop(THREE.LoopRepeat),boy_actions[animations.PUSH].clampWhenFinished=!1,boy_actions[animations.IDLE].setLoop(THREE.LoopRepeat),boy_actions[animations.IDLE].clampWhenFinished=!1,current_animation=animations.IDLE},void 0,e=>{console.error("Error loading avatar glb",e)});let envIdx=0;function changeGameScene(e){clearScene(currentScene),setupForScene(currentScene=e)}function setLevel(e){envController&&envController.SetVisibility(!1),(envController=envs[envIdx][5]).SetVisibility(!0)}prevEnvBtn.addEventListener("click",()=>{0===envIdx?envIdx=envs.length-1:envIdx--,levelNameElement.innerHTML=levelNames[envIdx],levelImageElement.setAttribute("style",`background-image: url(/img/env${envIdx}.jpg)`)}),nextEnvBtn.addEventListener("click",()=>{envIdx===envs.length-1?envIdx=0:envIdx++,levelNameElement.innerHTML=levelNames[envIdx],levelImageElement.setAttribute("style",`background-image: url(/img/env${envIdx}.jpg)`)}),prevOutfitBtn.addEventListener("click",()=>{0===currentOutfit?currentOutfit=outfits.length-1:currentOutfit--,setUpForCurrentOutfit(),characterNameElement.innerHTML=levelNames[currentOutfit]}),nextOutfitBtn.addEventListener("click",()=>{currentOutfit===outfits.length-1?currentOutfit=0:currentOutfit++,setUpForCurrentOutfit(),characterNameElement.innerHTML=levelNames[currentOutfit]}),SCENE={APPLE:0,OUTFIT:2,LEVEL:1,GAMEPLAY:3,GAMEOVER:4};let currentScene=SCENE.APPLE,currentScore=0,gameTime=0;function getCubeMapTexture(){(new THREE.RGBELoader).setDataType(THREE.UnsignedByteType).load("/assets/hdr/venice_sunset_1k.hdr",e=>{const n=pmremGenerator.fromEquirectangular(e).texture;pmremGenerator.dispose(),scene.environment=n})}function SetUpDefaultEnvProps(e){scene.fog=new THREE.FogExp2("#f0d3fd",.02),scene.fog.far=200,materialArray.forEach(e=>{e.color=new THREE.Color("#dfa6fb")})}function setupForScene(e){switch(e){case SCENE.APPLE:camera.position.set(-100,1,2.6);break;case SCENE.OUTFIT:if(!avatar)return setTimeout(()=>setupForScene(SCENE.OUTFIT),500);current_animation=animations.IDLE,HardResetAnimsToIdle(),avatar.position.set(200,0,0),avatar.rotation.y=0,camera.position.set(200,1,2.6),SetUpDefaultEnvProps();break;case SCENE.LEVEL:camera.position.set(-100,1,2.6);break;case SCENE.GAMEPLAY:skybox.visible=!0,current_animation=animations.PUSH,sceneTitle.hidden=!0,scoreWrapElement.hidden=!1,envController.InitTilesWithSpawnedObjects(),avatar.position.set(0,-1,.1),avatar.rotation.y=Math.PI,camera.position.set(0,1.4,4.6),currentScore=0,sceneTitle.innerHTML="score: "+Math.floor(currentScore),scoreElement.innerHTML="score: "+Math.floor(currentScore),leaderboardScoreElement.innerHTML="score: "+Math.floor(currentScore),current_lane=lanes.MIDDLE,gameTime=0;break;case SCENE.GAMEOVER:{skybox.visible=!1,current_animation=animations.IDLE,HardResetAnimsToIdle();let e=isTouchDevice?"touch":"press space";scoreWrapElement.hidden=!0,sceneTitle.hidden=!1,sceneTitle.innerHTML="score: "+Math.floor(currentScore)+"<br>"+e+" to skate a new location</br>",avatar.position.set(300,0,0),avatar.rotation.y=0,camera.position.set(300,1.4,2.6);break}}}function clearScene(e){switch(e){case SCENE.OUTFIT:break;case SCENE.GAMEPLAY:envController.Reset();break;case SCENE.GAMEOVER:}}function initFall(){current_animation=animations.FALL,boy_actions[animations.FALL].reset(),boy_actions[animations.FALL].setDuration(3),boy_actions[animations.FALL].time=.7,fetch(`${window.env.api}/score?token=${window.purpose_session.token}`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({gt:window.purpose_session.gt,score:Math.floor(currentScore)})}).then(e=>e.json()),setTimeout(function(){clearScene(currentScene),setupForScene(currentScene=SCENE.GAMEOVER)},1500)}function updateForScene(e,n){switch(n*=1.5,e){case SCENE.OUTFIT:break;case SCENE.GAMEPLAY:{gameTime+=n,playerMovementUpdate(n);let e=getCookie("p2.first")?3:2;document.cookie="p2.first=true";let t=current_animation==animations.FALL?0:e+Math.min(gameTime/30,6);if(envController.EnvUpdate(t*n),currentScore+=t*n/3,scoreElement.innerHTML="score: "+Math.floor(currentScore),leaderboardScoreElement.innerHTML="score: "+Math.floor(currentScore),envController.CollisionCheck("Coin",new THREE.Vector3(0,0,-1),new THREE.Vector3(0,.5,0))[0]&&(currentScore+=5),envController.CollisionCheck("Coin",new THREE.Vector3(0,0,-1),new THREE.Vector3(0,.1,0))[0]&&(currentScore+=5),current_animation==animations.FALL)break;let a=envController.CollisionCheck("Obstacle",new THREE.Vector3(0,0,-1),new THREE.Vector3(0,.1,-.2));if(a[0]&&a[1]<.3){initFall();break}let r=envController.CollisionCheck("Obstacle",new THREE.Vector3(1,0,0),new THREE.Vector3(0,.1,-.2));if(r[0]&&r[1]<.2){initFall();break}let o=envController.CollisionCheck("Obstacle",new THREE.Vector3(-1,0,0),new THREE.Vector3(0,.1,-.2));if(o[0]&&o[1]<.2){initFall();break}break}case SCENE.GAMEOVER:}animationUpdate(n)}getCubeMapTexture(),setupForScene(currentScene);let clock=new THREE.Clock;function render(){if(paused)return;requestAnimationFrame(render),renderer.render(scene,camera);let e=clock.getDelta();updateForScene(currentScene,e)}function togglePause(){paused=!paused,clock.stop(),renderLeaderboard(),paused?leaderboardElement.hidden=!1:(leaderboardElement.hidden=!0,clock.start(),render())}function renderLeaderboard(){let e="";window.purpose_session.leaderboard&&(window.purpose_session.leaderboard.forEach(n=>e+=createLbTr(n)),leaderboardScoresElement.innerHTML=e)}function createLbTr(e){return`<tr><td>${e.name}</td><td>${e.score}</td></tr>`}render();let lanes={LEFT:"LEFT",MIDDLE:"MIDDLE",RIGHT:"RIGHT"},lane_positions={MIDDLE:0,RIGHT:2.5,LEFT:-2.5},camera_positions={RIGHT:2.5,MIDDLE:0,LEFT:-2.5},current_lane=lanes.MIDDLE,movementParams={forwardSpeed:100,turnSpeed:100,blendSpeed:3,jumpHeight:2,jumpSpeed:.65};function is_touch_device4(){return"ontouchstart"in window||(!!(window.DocumentTouch&&document instanceof DocumentTouch)||window.matchMedia("(pointer: coarse)").matches)}window.addEventListener("keydown",e=>{if(currentScene===SCENE.GAMEPLAY)switch(e.keyCode){case 87:case 32:movePlayer("UP");break;case 65:movePlayer("LEFT");break;case 68:movePlayer("RIGHT");break;case 38:movePlayer("UP");break;case 37:movePlayer("LEFT");break;case 39:movePlayer("RIGHT")}currentScene===SCENE.GAMEOVER&&32===e.keyCode&&(changeUIScene("characterSelect"),clearScene(currentScene),setupForScene(currentScene=SCENE.OUTFIT))});let isTouchDevice=is_touch_device4();document.addEventListener("touchstart",handleTouchStart,!1),document.addEventListener("touchmove",handleTouchMove,!1);var xDown=null,yDown=null;function handleTouchStart(e){xDown=e.touches[0].clientX,yDown=e.touches[0].clientY,currentScene==SCENE.GAMEOVER&&(changeUIScene("characterSelect"),clearScene(currentScene),setupForScene(currentScene=SCENE.OUTFIT))}function handleTouchMove(e){if(xDown&&yDown){var n=e.touches[0].clientX,t=e.touches[0].clientY,a=xDown-n,r=yDown-t;Math.abs(a)>Math.abs(r)?movePlayer(a>0?"LEFT":"RIGHT"):r>0&&movePlayer("UP"),xDown=null,yDown=null}}var jumpFlipFlop=!0;function movePlayer(e){if(currentScene==SCENE.GAMEPLAY&&current_animation!=animations.FALL)switch(e){case"UP":if(jumping||landed)return;return jumping=!0,jump_time=0,1==jumpFlipFlop?(current_animation=animations.JUMP,boy_actions[animations.JUMP].reset(),boy_actions[animations.JUMP].setDuration(2.7),boy_actions[animations.JUMP].time=.3,jumpFlipFlop=!1):(current_animation=animations.OLLIE,boy_actions[animations.OLLIE].reset(),boy_actions[animations.OLLIE].setDuration(3),boy_actions[animations.OLLIE].time=.5,jumpFlipFlop=!0),void(avatar_land_tween&&avatar_land_tween.stop());case"DOWN":break;case"LEFT":if(current_lane===lanes.LEFT||1==landed)return;current_lane=current_lane===lanes.RIGHT?lanes.MIDDLE:lanes.LEFT,current_animation=animations.TURN_LEFT,boy_actions[animations.TURN_LEFT].reset(),boy_actions[animations.TURN_LEFT].time=.2;break;case"RIGHT":if(current_lane===lanes.RIGHT||1==landed)return;current_lane=current_lane===lanes.LEFT?lanes.MIDDLE:lanes.RIGHT,current_animation=animations.TURN_RIGHT,boy_actions[animations.TURN_RIGHT].reset(),boy_actions[animations.TURN_RIGHT].time=.2}}let avatar_land_tween,landed=!1,landHeight=0,maxPlayerDistanceDelta=3.5,maxCamDistanceDelta=3.5;function playerMovementUpdate(e){if(current_animation!==animations.FALL){let n=lane_positions[current_lane]-avatar.position.x;Math.abs(n)>e*maxPlayerDistanceDelta&&(avatar.position.x+=Math.sign(n)*e*maxPlayerDistanceDelta),n=camera_positions[current_lane]-camera.position.x,Math.abs(n)>e*maxCamDistanceDelta&&(camera.position.x+=Math.sign(n)*e*maxCamDistanceDelta)}if(jumping){if(jump_time+=movementParams.jumpSpeed*e,!landed){let e=envController.CollisionCheck("Jump",new THREE.Vector3(0,-1,0),new THREE.Vector3(0,.1,-.2));e[0]&&e[1]<.5&&(landed=!0,current_animation!==animations.FALL&&(current_animation=animations.TURN_RIGHT,boy_actions[animations.TURN_RIGHT].reset(),boy_actions[animations.TURN_RIGHT].setDuration(2.5),boy_actions[animations.TURN_RIGHT].time=.2),landHeight=avatar.position.y-e[1]+.1)}jump_time>=1&&(jumping=!1,jump_time=1);let n=Math.sin(Math.PI*jump_time);avatar.position.y=landed?landHeight:movementParams.jumpHeight*n-1}if(landed&&!jumping){envController.CollisionCheck("Jump",new THREE.Vector3(0,-1,0),new THREE.Vector3(0,.1,-.2))[0]||((avatar_land_tween=new TWEEN(avatar.position)).to({y:-1},100),avatar_land_tween.start(),landed=!1,current_animation!==animations.FALL&&(current_animation=animations.PUSH,boy_actions[animations.TURN_RIGHT].setDuration(1.4)))}}function animationUpdate(e){if(boy_actions.length<1)return;let n=boy_actions[current_animation];n.loop==THREE.LoopOnce&&n._clip.duration-n.time<.75&&current_animation!=animations.FALL&&(current_animation=animations.PUSH);for(let n=0;n<boy_actions.length;n++){let t=boy_actions[n].getEffectiveWeight();n==current_animation?(t=Math.min(t+movementParams.blendSpeed*e,1),boy_actions[n].setEffectiveWeight(t)):(t=Math.max(t-movementParams.blendSpeed*e,0),boy_actions[n].setEffectiveWeight(t))}boy_mixer.update(e)}function HardResetAnimsToIdle(){for(let e=0;e<boy_actions.length;e++)e==animations.IDLE?boy_actions[e].setEffectiveWeight(1):boy_actions[e].setEffectiveWeight(0)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}window.addEventListener("resize",onWindowResize,!1);